name: Update Metrics Filters

on:
  push:
    branches:
      - '*/metrics-filter-update-*'
      - 'jade**'  # TODO: Remove when finished testing

permissions:
  contents: write
  pull-requests: write

jobs:
  update-filters:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout embrace-docs
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Need full history to get commit SHA

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate filter documentation
        run: npm run generate:filters

      - name: Create PR if changes detected
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "embrace-ci[bot]"
          git config --global user.email "embrace-ci@users.noreply.github.com"

          # Extract commit SHA and actor from branch name
          # Branch format: {actor}/metrics-filter-update-{short_sha}
          branch="${{ github.ref_name }}"
          actor=$(echo "$branch" | cut -d'/' -f1)
          short_sha=$(echo "$branch" | cut -d'/' -f2 | sed 's/metrics-filter-update-//')
          
          # Get the full commit SHA from the metrics repo
          # The commit message contains the full SHA, or we can extract from the branch
          # For now, we'll use the short SHA in the PR title
          
          if [[ `git status --porcelain` ]]; then
            git add docs/definitions/filters.md
            git commit -m "CI/CD: Update metrics filters documentation from metrics repo"
            git push origin "$branch"

            # Extract commit SHA from the commit message or use the one in metrics.yaml if available
            # The commit message from metrics repo should have the full SHA
            commit_sha=$(git log --format=%B -n 1 HEAD~1 | grep -oP 'commit \K[a-f0-9]{40}' || echo "")
            if [ -z "$commit_sha" ]; then
              # Fallback: try to get from the branch name or use short SHA
              commit_sha="$short_sha"
            fi

            cat > message.txt <<EOF
Filter changes detected in metrics.yaml

This PR updates the metrics filters documentation based on changes in:
https://github.com/embrace-io/metrics/commit/${commit_sha}

This is an autogenerated PR. Please review the filter changes.
EOF

            gh pr create \
              --base main \
              --head "$branch" \
              --title "CI/CD: Update metrics filters documentation (${short_sha})" \
              --body-file message.txt
          else
            echo "No changes detected."
          fi
